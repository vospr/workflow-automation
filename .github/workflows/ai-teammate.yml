name: AI Teammate v2

on:
  # schedule:
  #   # Every 15 min, 8am-6pm UTC, Mon-Fri
  #   - cron: '*/15 8-18 * * 1-5'
  workflow_dispatch:
    inputs:
      ticket_key:
        description: 'Specific ticket key (leave empty to poll JQL)'
        required: false
        type: string

env:
  JIRA_BASE_PATH: ${{ secrets.JIRA_BASE_PATH }}
  JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
  JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
  JIRA_AUTH_TYPE: Basic
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  process-ticket:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install DMTOOLS
        run: |
          curl -fsSL https://raw.githubusercontent.com/IstiN/dmtools/main/install.sh | bash
          echo "$HOME/.dmtools/bin" >> $GITHUB_PATH

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Select ticket
        id: select-ticket
        run: |
          export PATH="$HOME/.dmtools/bin:$PATH"
          if [ -n "${{ inputs.ticket_key }}" ]; then
            echo "ticket_key=${{ inputs.ticket_key }}" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
            echo "Selected manually: ${{ inputs.ticket_key }}"
          else
            RESULT=$(dmtools jira_search_by_jql \
              "assignee = currentUser() AND labels in ('AI', 'AI-REVIEW') ORDER BY priority DESC, created ASC" \
              "key,summary,labels,issuetype" \
              --limit 1)

            TICKET_KEY=$(echo "$RESULT" | jq -r '.[0].key // empty')

            if [ -z "$TICKET_KEY" ]; then
              echo "No tickets found with AI label. Exiting."
              echo "found=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "ticket_key=$TICKET_KEY" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
            echo "Selected from JQL: $TICKET_KEY"
          fi

      - name: Fetch ticket context
        if: steps.select-ticket.outputs.found != 'false'
        run: |
          export PATH="$HOME/.dmtools/bin:$PATH"
          TICKET=${{ steps.select-ticket.outputs.ticket_key }}
          mkdir -p input/$TICKET outputs planning-artifacts implementation-artifacts

          # Fetch ticket data
          dmtools jira_get_ticket $TICKET \
            summary,description,status,labels,issuetype,priority,acceptance_criteria \
            > input/$TICKET/ticket.json

          # Fetch child tickets
          dmtools jira_search_by_jql "parent = $TICKET" \
            "key,summary,status,description" \
            > input/$TICKET/children.json || echo "[]" > input/$TICKET/children.json

          # Fetch comments
          dmtools jira_get_comments $TICKET \
            > input/$TICKET/comments.json || echo "[]" > input/$TICKET/comments.json

          # Determine task type from labels
          LABELS=$(cat input/$TICKET/ticket.json | jq -r '.fields.labels | join(",")')
          if echo "$LABELS" | grep -qi "AI-REVIEW"; then
            echo "review" > input/$TICKET/task_type.txt

            # For review tasks, fetch PR review comments
            PR_URL=$(gh pr list --head "feature/$TICKET" --json url --jq '.[0].url' || echo "")
            if [ -n "$PR_URL" ]; then
              gh pr view "$PR_URL" --json reviews,comments \
                > input/$TICKET/pr_review.json || echo "{}" > input/$TICKET/pr_review.json
            fi
          else
            ISSUE_TYPE=$(cat input/$TICKET/ticket.json | jq -r '.fields.issuetype.name')
            case "$ISSUE_TYPE" in
              Bug|Story) echo "code" > input/$TICKET/task_type.txt ;;
              Task|Analysis) echo "analysis" > input/$TICKET/task_type.txt ;;
              *) echo "analysis" > input/$TICKET/task_type.txt ;;
            esac
          fi

          echo "Task type: $(cat input/$TICKET/task_type.txt)"

      - name: Run Claude Code (Orchestrated)
        if: steps.select-ticket.outputs.found != 'false'
        run: |
          TICKET=${{ steps.select-ticket.outputs.ticket_key }}
          TASK_TYPE=$(cat input/$TICKET/task_type.txt)

          # Build orchestration prompt
          chmod +x scripts/build-orchestration-prompt.sh
          PROMPT=$(bash scripts/build-orchestration-prompt.sh "$TICKET" "$TASK_TYPE")

          # Run Claude Code as Main Agent â€” CLAUDE.md auto-loads
          claude -p "$PROMPT" --dangerously-skip-permissions

      - name: Route output
        if: steps.select-ticket.outputs.found != 'false'
        run: |
          export PATH="$HOME/.dmtools/bin:$PATH"
          TICKET=${{ steps.select-ticket.outputs.ticket_key }}
          TASK_TYPE=$(cat input/$TICKET/task_type.txt)

          # Verify outputs/response.md exists
          if [ ! -f "outputs/response.md" ]; then
            echo "ERROR: outputs/response.md not found. Claude may have failed."
            dmtools jira_post_comment $TICKET "AI Teammate v2: No output produced. Check GitHub Actions logs."
            dmtools jira_remove_label $TICKET "AI"
            dmtools jira_add_label $TICKET "AI_FAILED"
            exit 1
          fi

          case "$TASK_TYPE" in
            analysis)
              RESPONSE=$(cat outputs/response.md)
              dmtools jira_post_comment $TICKET "$RESPONSE"
              dmtools jira_remove_label $TICKET "AI"
              dmtools jira_add_label $TICKET "AI_PROCESSED"
              echo "Posted analysis comment to $TICKET"
              ;;
            code|review)
              node agents/postActions/developTicketAndCreatePR.js $TICKET
              ;;
          esac

      - name: Upload artifacts
        if: always() && steps.select-ticket.outputs.found != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ai-teammate-artifacts-${{ steps.select-ticket.outputs.ticket_key }}
          path: |
            planning-artifacts/
            implementation-artifacts/
            outputs/
          retention-days: 30
